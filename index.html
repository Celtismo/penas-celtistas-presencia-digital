<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Presencia digital de las peñas celtistas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Datos públicos sobre presencia digital y RRSS de peñas celtistas.">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; max-width: 1350px; }
    h1 { margin: 0 0 6px; }
    .meta { font-size: 14px; opacity: .8; margin: 0 0 12px; }
    .bar { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin: 12px 0; }
    input { padding: 8px 10px; font-size: 14px; min-width: 320px; }
    .pill { border: 1px solid #ccc; border-radius: 999px; padding: 2px 8px; font-size: 12px; }

    table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    th, td {
      border-bottom: 1px solid #e5e5e5;
      padding: 8px 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      vertical-align: top;
    }
    th { background: #fafafa; cursor: pointer; position: sticky; top: 0; user-select: none; }
    th small { opacity: .5; margin-left: 4px; }
    tr:hover td { background: #f9f9f9; }

    a { color: inherit; text-decoration: underline; text-underline-offset: 2px; }

    th.col-total, td.col-total { width: 110px; text-align: right; }
    th.col-pena,  td.col-pena  { width: 360px; text-align: left; }
    th.col-web,   td.col-web   { width: 70px;  text-align: center; }
    th.col-net,   td.col-net   { width: 110px; text-align: right; }

    .wrap { word-break: break-word; }
  </style>
</head>
<body>

<h1>Presencia digital de las peñas celtistas</h1>
<div class="meta">Datos públicos. No es listado oficial ni ranking.</div>

<div class="bar">
  <input id="q" type="search" placeholder="Buscar peña, usuario o URL…">
  <span id="count" class="pill">0 filas</span>
  <span class="meta">CSV: <a id="csvLink" href="#">abrir</a></span>
  <span id="updated" class="meta"></span>
</div>

<table>
  <thead><tr id="hdr"></tr></thead>
  <tbody id="body"></tbody>
</table>

<script>
const CSV_FILE = "penas-celtistas-rrss.csv";
document.getElementById("csvLink").href = CSV_FILE;

const q = document.getElementById("q");
const hdr = document.getElementById("hdr");
const body = document.getElementById("body");
const count = document.getElementById("count");
const updated = document.getElementById("updated");

const NF = new Intl.NumberFormat("es-ES", { useGrouping: true });

function normHeader(h){ return String(h || "").trim().replace(/^\uFEFF/, ""); }
function isUrl(v){ return /^https?:\/\//i.test(String(v || "").trim()); }

function toNum(v){
  const s = String(v ?? "").trim();
  const n = Number(s.replace(/\./g, "").replace(/,/g, ""));
  return Number.isFinite(n) ? n : null;
}
function fmtNum(v){
  const n = toNum(v);
  return n === null ? "" : NF.format(n);
}
function isZeroish(v){
  const n = toNum(v);
  return n === null ? false : n === 0;
}
function esc(s){
  return String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}
function cleanHandle(v){
  return String(v ?? "").trim().replace(/^@/, "");
}

/**
 * Mapeo EXACTO a tu CSV actual:
 * Total: Seg
 * Peña: peña
 * Web: web + Unnamed: 4 (url)
 * X: X + Unnamed: 6 (user)
 * Instagram: Instagram + Unnamed: 8 (user)
 * Facebook: Facebook + Unnamed: 10 (url)
 * Youtube: Youtube + Unnamed: 12 (url)
 * TikTok: TikTok + Unnamed: 14 (url o user)
 * Bluesky: Bluesky + Unnamed: 16 (url o handle)
 * Feeberse: Feeberse (sin link asociado en tu CSV actual)
 */
const COLS = [
  { key:"Seg",      label:"Total",     cls:"col-total", linkFrom:null,     linkType:null },
  { key:"peña",     label:"Peña",      cls:"col-pena",  linkFrom:null,     linkType:null },
  { key:"web",      label:"Web",       cls:"col-web",   linkFrom:"Unnamed: 4",  linkType:"web_ok" },
  { key:"X",        label:"X",         cls:"col-net",   linkFrom:"Unnamed: 6",  linkType:"x_user" },
  { key:"Instagram",label:"Instagram", cls:"col-net",   linkFrom:"Unnamed: 8",  linkType:"ig_user" },
  { key:"Facebook", label:"Facebook",  cls:"col-net",   linkFrom:"Unnamed: 10", linkType:"url" },
  { key:"Youtube",  label:"YouTube",   cls:"col-net",   linkFrom:"Unnamed: 12", linkType:"url" },
  { key:"TikTok",   label:"TikTok",    cls:"col-net",   linkFrom:"Unnamed: 14", linkType:"tt_mixed" },
  { key:"Bluesky",  label:"Bluesky",   cls:"col-net",   linkFrom:"Unnamed: 16", linkType:"bsky_mixed" },
  { key:"Feeberse", label:"Feebers",   cls:"col-net",   linkFrom:null,          linkType:null }
];

let headers = [];
let rows = [];
let visible = [];
let sortKey = "peña";
let sortDir = 1;

function buildVisible(){
  const hs = new Set(headers);
  visible = COLS.filter(c => hs.has(c.key));
}

function cellHTML(r, c){
  const v = String(r[c.key] ?? "").trim();

  // ocultar vacíos y ceros numéricos (menos en web/peña)
  if (c.key !== "web" && c.key !== "peña" && isZeroish(v)) return "";
  if (v === "" || v === "0") {
    if (c.key === "web" && v.toUpperCase() === "OK") return "OK";
    return "";
  }

  // Total
  if (c.key === "Seg") {
    const f = fmtNum(v);
    return f || esc(v);
  }

  // Peña
  if (c.key === "peña") return `<span class="wrap">${esc(v)}</span>`;

  // Web: OK clicable si hay URL
  if (c.linkType === "web_ok") {
    const url = String(r[c.linkFrom] ?? "").trim();
    if (v.toUpperCase() === "OK" && isUrl(url)) {
      return `<a href="${url}" target="_blank" rel="noopener noreferrer nofollow">OK</a>`;
    }
    return (v.toUpperCase() === "OK") ? "OK" : esc(v);
  }

  // Si no es número, mostrar tal cual (o enlace si fuese URL)
  const n = toNum(v);
  if (n === null) {
    if (isUrl(v)) return `<a href="${v}" target="_blank" rel="noopener noreferrer nofollow">enlace</a>`;
    return esc(v);
  }

  const label = NF.format(n);
  const extra = c.linkFrom ? String(r[c.linkFrom] ?? "").trim() : "";

  // Facebook/Youtube: extra suele ser URL
  if (c.linkType === "url") {
    if (isUrl(extra)) return `<a href="${extra}" target="_blank" rel="noopener noreferrer nofollow">${label}</a>`;
    return label;
  }

  // X: extra es user
  if (c.linkType === "x_user") {
    const h = cleanHandle(extra);
    if (!h) return label;
    const url = `https://x.com/${encodeURIComponent(h)}`;
    return `<a href="${url}" target="_blank" rel="noopener noreferrer nofollow">${label}</a>`;
  }

  // Instagram: extra es user
  if (c.linkType === "ig_user") {
    const h = cleanHandle(extra);
    if (!h) return label;
    const url = `https://www.instagram.com/${encodeURIComponent(h)}/`;
    return `<a href="${url}" target="_blank" rel="noopener noreferrer nofollow">${label}</a>`;
  }

  // TikTok: extra puede ser URL o user
  if (c.linkType === "tt_mixed") {
    if (isUrl(extra)) return `<a href="${extra}" target="_blank" rel="noopener noreferrer nofollow">${label}</a>`;
    const h = cleanHandle(extra);
    if (!h) return label;
    const url = `https://www.tiktok.com/@${encodeURIComponent(h)}`;
    return `<a href="${url}" target="_blank" rel="noopener noreferrer nofollow">${label}</a>`;
  }

  // Bluesky: extra puede ser URL o handle / dominio
  if (c.linkType === "bsky_mixed") {
    if (isUrl(extra)) return `<a href="${extra}" target="_blank" rel="noopener noreferrer nofollow">${label}</a>`;
    const h = cleanHandle(extra);
    if (!h) return label;
    const url = `https://bsky.app/profile/${encodeURIComponent(h)}`;
    return `<a href="${url}" target="_blank" rel="noopener noreferrer nofollow">${label}</a>`;
  }

  // sin link
  return label;
}

function renderHeader(){
  hdr.innerHTML = "";
  visible.forEach(c => {
    const th = document.createElement("th");
    th.className = c.cls;
    th.innerHTML = `${c.label}<small>↕</small>`;
    th.onclick = () => {
      sortDir = (sortKey === c.key) ? -sortDir : 1;
      sortKey = c.key;
      render();
    };
    hdr.appendChild(th);
  });
}

function render(){
  const term = q.value.toLowerCase();

  let list = rows.filter(r => {
    if (!term) return true;
    // busca en todas las columnas del row
    return Object.values(r).some(v => String(v ?? "").toLowerCase().includes(term));
  });

  list.sort((a,b) => {
    const av = String(a[sortKey] ?? "").trim();
    const bv = String(b[sortKey] ?? "").trim();
    const an = toNum(av), bn = toNum(bv);

    if (an !== null && bn !== null) return (an - bn) * sortDir;
    return av.localeCompare(bv, "es", { sensitivity: "base" }) * sortDir;
  });

  body.innerHTML = "";
  for (const r of list) {
    const tr = document.createElement("tr");
    for (const c of visible) {
      const td = document.createElement("td");
      td.className = c.cls;
      td.innerHTML = cellHTML(r, c);
      tr.appendChild(td);
    }
    body.appendChild(tr);
  }

  count.textContent = `${list.length} filas`;

  // fecha arriba si existe
  const fc = "fecha_actualizacion";
  if (headers.includes(fc)) {
    const freq = {};
    for (const r of list) {
      const d = String(r[fc] || "").trim();
      if (d) freq[d] = (freq[d] || 0) + 1;
    }
    const top = Object.entries(freq).sort((x,y)=>y[1]-x[1])[0];
    updated.textContent = top ? `Última actualización: ${top[0]}` : "";
  } else {
    updated.textContent = "";
  }
}

fetch(CSV_FILE, { cache:"no-store" })
  .then(r => r.text())
  .then(t => {
    const lines = t.split(/\r?\n/).filter(l => l.trim() !== "");
    headers = lines[0].split(";").map(normHeader);

    rows = lines.slice(1).map(line => {
      const p = line.split(";");
      const o = {};
      headers.forEach((h,i) => o[h] = (p[i] ?? "").trim());
      return o;
    });

    buildVisible();
    renderHeader();
    render();
  });

q.addEventListener("input", render);
</script>

</body>
</html>
