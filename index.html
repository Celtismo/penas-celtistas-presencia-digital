<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Presencia digital de las peñas celtistas</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: system-ui, Arial, sans-serif; margin: 24px; max-width: 1300px; }
h1 { margin-bottom: 4px; }
.meta { font-size: 14px; opacity: .8; margin-bottom: 12px; }
.bar { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin:12px 0; }
input { padding:8px 10px; min-width:300px; }
.pill { border:1px solid #ccc; border-radius:999px; padding:2px 8px; font-size:12px; }

table { width:100%; border-collapse:collapse; table-layout:fixed; }
th,td { border-bottom:1px solid #e5e5e5; padding:8px 6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
th { background:#fafafa; cursor:pointer; position:sticky; top:0; }
tr:hover td { background:#f9f9f9; }

th.col-total, td.col-total { width:110px; text-align:right; }
th.col-pena,  td.col-pena  { width:320px; text-align:left; }
th.col-web,   td.col-web   { width:70px;  text-align:center; }
th.col-net,   td.col-net   { width:110px; text-align:right; }

a { color:inherit; text-decoration:underline; }
</style>
</head>
<body>

<h1>Presencia digital de las peñas celtistas</h1>
<div class="meta">Datos públicos. No es listado oficial ni ranking.</div>

<div class="bar">
  <input id="q" type="search" placeholder="Buscar peña, usuario o URL…">
  <span id="count" class="pill">0 filas</span>
  <span class="meta">CSV: <a id="csvLink" href="#">abrir</a></span>
  <span id="updated" class="meta"></span>
</div>

<table>
<thead><tr id="hdr"></tr></thead>
<tbody id="body"></tbody>
</table>

<script>
const CSV_FILE = "penas-celtistas-rrss.csv";
document.getElementById("csvLink").href = CSV_FILE;

const COLS = [
  { key:"Total_rrss", label:"Total", cls:"col-total" },
  { key:"Peñas", label:"Peñas", cls:"col-pena" },
  { key:"web", label:"Web", cls:"col-web" },
  { key:"X", label:"X", cls:"col-net" },
  { key:"Instagram", label:"Instagram", cls:"col-net" },
  { key:"Facebook", label:"Facebook", cls:"col-net" },
  { key:"Youtube", label:"YouTube", cls:"col-net" },
  { key:"TikTok", label:"TikTok", cls:"col-net" },
  { key:"Bluesky", label:"Bluesky", cls:"col-net" },
  { key:"Feeberse", label:"Feebers", cls:"col-net" }
];

const q = document.getElementById("q");
const hdr = document.getElementById("hdr");
const body = document.getElementById("body");
const count = document.getElementById("count");
const updated = document.getElementById("updated");

let rows=[], headers=[], sortKey="Peñas", sortDir=1;

const NF = new Intl.NumberFormat("es-ES");

function isNum(v){
  const n = Number(String(v).replace(/\./g,"").replace(/,/g,""));
  return Number.isFinite(n);
}
function fmt(v){ return NF.format(Number(String(v).replace(/\./g,"").replace(/,/g,""))); }
function isUrl(v){ return /^https?:\/\//i.test(v); }

function renderHeader(){
  hdr.innerHTML="";
  COLS.forEach(c=>{
    if(!headers.includes(c.key)) return;
    const th=document.createElement("th");
    th.className=c.cls;
    th.textContent=c.label+" ↕";
    th.onclick=()=>{ sortDir=(sortKey===c.key?-sortDir:1); sortKey=c.key; render(); };
    hdr.appendChild(th);
  });
}

function render(){
  const term=q.value.toLowerCase();
  let list=rows.filter(r=>Object.values(r).some(v=>String(v).toLowerCase().includes(term)));

  list.sort((a,b)=>{
    const av=a[sortKey]||"", bv=b[sortKey]||"";
    if(isNum(av)&&isNum(bv)) return (Number(av)-Number(bv))*sortDir;
    return String(av).localeCompare(String(bv),"es",{sensitivity:"base"})*sortDir;
  });

  body.innerHTML="";
  list.forEach(r=>{
    const tr=document.createElement("tr");
    COLS.forEach(c=>{
      if(!headers.includes(c.key)) return;
      const td=document.createElement("td");
      td.className=c.cls;
      const v=r[c.key]||"";
      if(c.key==="web" && v==="OK"){
        const url=r[headers[headers.indexOf(c.key)+1]];
        td.innerHTML=isUrl(url)?`<a href="${url}" target="_blank">OK</a>`:"OK";
      } else if(isNum(v)){
        const url=r[headers[headers.indexOf(c.key)+1]];
        td.innerHTML=isUrl(url)?`<a href="${url}" target="_blank">${fmt(v)}</a>`:fmt(v);
      } else {
        td.textContent=v;
      }
      tr.appendChild(td);
    });
    body.appendChild(tr);
  });
  count.textContent=list.length+" filas";
}

fetch(CSV_FILE,{cache:"no-store"})
.then(r=>r.text())
.then(t=>{
  const lines=t.trim().split(/\r?\n/);
  headers=lines[0].split(";");
  rows=lines.slice(1).map(l=>{
    const p=l.split(";");
    const o={};
    headers.forEach((h,i)=>o[h]=p[i]||"");
    return o;
  });
  renderHeader(); render();
});
q.oninput=render;
</script>

</body>
</html>
