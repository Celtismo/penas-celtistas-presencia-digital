<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Presencia digital de las peñas celtistas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Datos públicos sobre la presencia en internet y redes sociales de las peñas celtistas.">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; max-width: 1200px; }
    h1 { margin-bottom: 6px; }
    .meta { font-size: 14px; opacity: .8; margin-bottom: 12px; }
    .bar { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 12px; }
    input { padding: 8px 10px; font-size: 14px; min-width: 260px; }
    .pill { border: 1px solid #ccc; border-radius: 999px; padding: 2px 8px; font-size: 12px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #e5e5e5; padding: 8px 6px; vertical-align: top; }
    th { cursor: pointer; background: #fafafa; position: sticky; top: 0; }
    th small { opacity: .5; margin-left: 4px; }
    tr:hover td { background: #f9f9f9; }
    a { color: inherit; }
    .num { text-align: right; font-variant-numeric: tabular-nums; }
    .wrap { word-break: break-word; }
  </style>
</head>
<body>

<h1>Presencia digital de las peñas celtistas</h1>
<div class="meta">
  Dataset informativo basado únicamente en datos públicos. No es un listado oficial ni un ranking de importancia.
</div>

<div class="bar">
  <input id="q" type="search" placeholder="Buscar peña, usuario o URL…">
  <span id="count" class="pill">0 filas</span>
  <span class="meta">CSV: <a id="csvLink" href="#">abrir</a></span>
  <span id="updated" class="meta"></span>
</div>

<table>
  <thead>
    <tr id="hdr"></tr>
  </thead>
  <tbody id="body"></tbody>
</table>

<script>
/* ================= CONFIG ================= */
const CSV_FILE = "penas-celtistas-rrss.csv"; // nombre EXACTO del CSV en el repo

// Columnas que queremos mostrar (si existen en el CSV)
const WANTED_COLS = [
  "Peñas",
  "web",
  "X",
  "Instagram",
  "Facebook",
  "Youtube",
  "TikTok",
  "Bluesky",
  "Feebers",
  "fecha_actualizacion"
];

/* ================= DOM ================= */
const q = document.getElementById("q");
const hdr = document.getElementById("hdr");
const body = document.getElementById("body");
const count = document.getElementById("count");
const csvLink = document.getElementById("csvLink");
const updated = document.getElementById("updated");
csvLink.href = CSV_FILE;

/* ================= STATE ================= */
let rows = [];
let cols = [];
let sortCol = null;
let sortDir = 1;

/* ================= UTILS ================= */
function stripBOM(s){ return s.replace(/^\uFEFF/, ""); }

function parseCSV(text){
  const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
  const header = stripBOM(lines[0]).split(";").map(h => h.trim());
  const data = lines.slice(1).map(line => {
    const parts = line.split(";");
    const o = {};
    header.forEach((h,i) => o[h] = (parts[i] || "").trim());
    return o;
  });
  return { header, data };
}

function isNum(v){
  return v !== "" && !isNaN(v);
}

function cell(v){
  if (!v || v === "0") return "";
  if (v.startsWith("http://") || v.startsWith("https://")) {
    return `<a class="wrap" href="${v}" target="_blank" rel="noopener noreferrer nofollow">${v}</a>`;
  }
  return `<span class="wrap">${v}</span>`;
}

/* ================= RENDER ================= */
function renderHeader(){
  hdr.innerHTML = "";
  cols.forEach(c => {
    const th = document.createElement("th");
    th.innerHTML = `${c}<small>↕</small>`;
    th.onclick = () => {
      sortDir = (sortCol === c) ? -sortDir : 1;
      sortCol = c;
      render();
    };
    hdr.appendChild(th);
  });
}

function render(){
  const term = q.value.toLowerCase();
  let list = rows.filter(r =>
    cols.some(c => (r[c] || "").toLowerCase().includes(term))
  );

  if (sortCol) {
    list = list.slice().sort((a,b) => {
      const av = a[sortCol] || "";
      const bv = b[sortCol] || "";
      if (isNum(av) && isNum(bv)) return (av - bv) * sortDir;
      return av.localeCompare(bv, "es", { sensitivity: "base" }) * sortDir;
    });
  }

  body.innerHTML = "";
  list.forEach(r => {
    const tr = document.createElement("tr");
    cols.forEach(c => {
      const td = document.createElement("td");
      const v = r[c] || "";
      if (isNum(v)) td.className = "num";
      td.innerHTML = cell(v);
      tr.appendChild(td);
    });
    body.appendChild(tr);
  });

  count.textContent = `${list.length} filas`;

  if (cols.includes("fecha_actualizacion")) {
    const freq = {};
    list.forEach(r => {
      const d = r["fecha_actualizacion"];
      if (d) freq[d] = (freq[d] || 0) + 1;
    });
    const top = Object.entries(freq).sort((a,b)=>b[1]-a[1])[0];
    updated.textContent = top ? `Última actualización: ${top[0]}` : "";
  }
}

/* ================= LOAD ================= */
async function load(){
  const res = await fetch(CSV_FILE, { cache: "no-store" });
  const text = await res.text();
  const parsed = parseCSV(text);

  cols = WANTED_COLS.filter(c => parsed.header.includes(c));
  rows = parsed.data;

  renderHeader();
  render();
}

q.addEventListener("input", render);
load();
</script>

</body>
</html>
